<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="position-sticky pt-3">
                <div class="text-center mb-4">
                    <i class="fas fa-shield-alt fa-2x text-white mb-2"></i>
                    <h5 class="text-white">Antivirus Dashboard</h5>
                </div>
                
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/dashboard">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active text-white" href="/hashes">
                            <i class="fas fa-list me-2"></i>
                            Hashlar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/scan">
                            <i class="fas fa-search me-2"></i>
                            Fayl tekshirish
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/settings">
                            <i class="fas fa-cog me-2"></i>
                            Sozlamalar
                        </a>
                    </li>
                </ul>
                
                <hr class="text-white">
                
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/auth/logout">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            Chiqish
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-list me-2"></i>
                    Hashlar ro'yxati
                </h1>
            </div>

            <!-- Upload Section -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-upload me-2"></i>
                                Virus faylini yuklash
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="uploadForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="virusFile" class="form-label">Virus faylini tanlang</label>
                                    <input type="file" class="form-control" id="virusFile" name="virusFile" accept=".txt" required>
                                    <div class="form-text">Faqat .txt fayllar qabul qilinadi</div>
                                </div>
                                <button type="submit" class="btn btn-primary" id="uploadBtn">
                                    <i class="fas fa-upload me-2"></i>Yuklashni boshlash
                                </button>
                            </form>
                            
                            <!-- Upload Progress -->
                            <div id="uploadProgress" class="mt-3" style="display: none;">
                                <div class="progress mb-2" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                         role="progressbar" 
                                         style="width: 0%; font-size: 12px; line-height: 25px; font-weight: bold;" 
                                         id="progressBarText">0%</div>
                                </div>
                                <div class="text-muted small" id="progressText">Yuklash boshlandi...</div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <span id="processedCount">0</span> / <span id="totalCount">0</span> hashlar tekshirildi
                                        (<span id="currentBatch">0</span> / <span id="totalBatches">0</span> batch)
                                    </small>
                                </div>
                                <div class="mt-1">
                                    <small class="text-success">Yangi: <span id="newHashesCount">0</span></small> | 
                                    <small class="text-warning">Mavjud: <span id="existingHashesCount">0</span></small> | 
                                    <small class="text-danger">Xatolik: <span id="errorsCount">0</span></small>
                                </div>
                            </div>
                            
                            <!-- Upload Results -->
                            <div id="uploadResults" class="mt-3" style="display: none;">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-check-circle me-2"></i>Yuklash muvaffaqiyatli yakunlandi!</h6>
                                    <div id="resultsDetails"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-plus me-2"></i>
                                Yangi hash qo'shish
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="addHashForm">
                                <div class="mb-3">
                                    <label for="newHash" class="form-label">Virus hash</label>
                                    <input type="text" class="form-control" id="newHash" name="hash" placeholder="Hash kiriting..." required>
                                    <div class="form-text">MD5, SHA1 yoki SHA256 hash</div>
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-plus me-2"></i>Qo'shish
                                </button>
                            </form>
                            
                            <div id="addHashResult" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                        Jami Hashlar
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalHashes">
                                        {{totalHashes}}
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-database fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card border-left-success shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Bugun qo'shilgan
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="todayAdded">
                                        {{todayAdded}}
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-plus-circle fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        O'tgan hafta
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="lastWeek">
                                        {{lastWeek}}
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-calendar-week fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        O'tgan oy
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="lastMonth">
                                        {{lastMonth}}
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hash List -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-list me-2"></i>
                        Hashlar ro'yxati
                    </h6>
                    <div class="d-flex gap-2">
                        <div class="position-relative" style="width: 200px;">
                            <input type="text" class="form-control form-control-sm" id="searchHash" placeholder="Hash qidirish..." style="padding-right: 30px;">
                            <button type="button" class="btn btn-sm btn-link position-absolute" id="clearSearch" style="right: 0; top: 0; display: none; z-index: 10; color: #6c757d;" onclick="clearSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" id="refreshBtn" onclick="refreshHashList()">
                            <i class="fas fa-sync-alt" id="refreshIcon"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="hashTable">
                            <thead>
                                <tr>
                                    <th>Hash</th>
                                    <th>Qo'shilgan vaqt</th>
                                    <th>Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="hashTableBody">
                                {{#each hashes}}
                                <tr>
                                    <td><code>{{this.hash}}</code></td>
                                    <td>{{formatDate this.addedAt}}</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="deleteHash('{{this._id}}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Hash pagination">
                        <ul class="pagination justify-content-center" id="pagination">
                           
                        </ul>
                    </nav>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
let currentPage = 1;
const hashesPerPage = 20;

document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('virusFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Iltimos, fayl tanlang!');
        return;
    }
    
    formData.append('virusFile', file);
    
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('uploadResults').style.display = 'none';
    document.getElementById('uploadBtn').disabled = true;
    
    document.getElementById('processedCount').textContent = '0';
    document.getElementById('totalCount').textContent = '0';
    document.getElementById('currentBatch').textContent = '0';
    document.getElementById('totalBatches').textContent = '0';
    document.getElementById('newHashesCount').textContent = '0';
    document.getElementById('existingHashesCount').textContent = '0';
    document.getElementById('errorsCount').textContent = '0';
    
    try {
        const response = await fetch('/api/hashes/upload', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        try {
            while (true) {
                const { done, value } = await reader.read();
                
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.progress !== undefined) {
                                const progressBar = document.querySelector('#uploadProgress .progress-bar');
                                progressBar.style.width = data.progress + '%';
                                progressBar.setAttribute('aria-valuenow', data.progress);
                                progressBar.textContent = data.progress + '%';
                                
                                document.getElementById('progressText').textContent = 
                                    `Yuklash davom etmoqda... ${data.progress}% (${data.processed}/${data.total})`;
                                
                                document.getElementById('processedCount').textContent = data.processed || 0;
                                document.getElementById('totalCount').textContent = data.total || 0;
                                document.getElementById('currentBatch').textContent = data.currentBatch || 0;
                                document.getElementById('totalBatches').textContent = data.totalBatches || 0;
                                document.getElementById('newHashesCount').textContent = data.newHashes || 0;
                                document.getElementById('existingHashesCount').textContent = data.existingHashes || 0;
                                document.getElementById('errorsCount').textContent = data.errors || 0;
                            }
                            
                            if (data.completed) {
                                if (data.success) {
                                    showUploadResults(data.data);
            refreshStats();
        } else {
                                    alert('Xatolik: ' + data.message);
                                }
                                document.getElementById('uploadProgress').style.display = 'none';
                                document.getElementById('uploadBtn').disabled = false;
                                return;
                            }
                        } catch (error) {
                            console.error('Progress data parsing error:', error);
                        }
                    }
                }
            }
        } finally {
            reader.releaseLock();
        }
    } catch (error) {
        alert('Yuklashda xatolik yuz berdi: ' + error.message);
        document.getElementById('uploadProgress').style.display = 'none';
        document.getElementById('uploadBtn').disabled = false;
    }
});

document.getElementById('addHashForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const hash = document.getElementById('newHash').value.trim();
    
    try {
        const response = await fetch('/api/hashes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ hash: hash })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAddHashResult('Hash muvaffaqiyatli qo\'shildi!', 'success');
            document.getElementById('newHash').value = '';
            refreshStats();
            refreshHashList();
        } else {
            showAddHashResult(result.message, 'danger');
        }
    } catch (error) {
        showAddHashResult('Xatolik yuz berdi: ' + error.message, 'danger');
    }
});

function showUploadResults(data) {
    const resultsDiv = document.getElementById('uploadResults');
    const detailsDiv = document.getElementById('resultsDetails');
    
    detailsDiv.innerHTML = '<ul class="mb-0">' +
        '<li>Jami hashlar: ' + data.totalHashes + '</li>' +
        '<li>Yangi qo\'shilgan: ' + data.newHashes + '</li>' +
        '<li>Mavjud (o\'tkazib yuborilgan): ' + data.existingHashes + '</li>' +
        '<li>Xatoliklar: ' + data.errors + '</li>' +
        '</ul>';
    
    resultsDiv.style.display = 'block';
}

function showAddHashResult(message, type) {
    const resultDiv = document.getElementById('addHashResult');
    resultDiv.className = 'alert alert-' + type;
    resultDiv.innerHTML = message;
    resultDiv.style.display = 'block';
    
    setTimeout(function() {
        resultDiv.style.display = 'none';
    }, 3000);
}

async function refreshStats() {
    try {
        const response = await fetch('/api/dashboard/stats');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('totalHashes').textContent = data.data.totalHashes;
            document.getElementById('todayAdded').textContent = data.data.todayAdded;
            document.getElementById('lastWeek').textContent = data.data.lastWeek;
            document.getElementById('lastMonth').textContent = data.data.lastMonth;
        }
    } catch (error) {
        console.error('Stats yangilashda xatolik:', error);
    }
}

async function refreshHashList() {
    // Add spinning animation
    const refreshBtn = document.getElementById('refreshBtn');
    const refreshIcon = document.getElementById('refreshIcon');
    
    refreshBtn.disabled = true;
    refreshIcon.classList.add('fa-spin');
    
    try {
        const response = await fetch('/api/hashes?page=' + currentPage + '&limit=' + hashesPerPage);
        const data = await response.json();
        
        if (data.success) {
            updateHashTable(data.data.hashes);
            updatePagination(data.data.pagination);
            refreshStats();
        }
    } catch (error) {
        console.error('Hash ro\'yxatini yangilashda xatolik:', error);
    } finally {
        setTimeout(() => {
            refreshBtn.disabled = false;
            refreshIcon.classList.remove('fa-spin');
        }, 500);
    }
}

function updateHashTable(hashes) {
    const tbody = document.getElementById('hashTableBody');
    tbody.innerHTML = '';
    
    hashes.forEach(function(hash) {
        const row = document.createElement('tr');
        row.innerHTML = '<td><code>' + hash.hash + '</code></td>' +
            '<td>' + formatDate(hash.addedAt) + '</td>' +
            '<td><button class="btn btn-sm btn-danger" onclick="deleteHash(\'' + hash._id + '\')">' +
            '<i class="fas fa-trash"></i></button></td>';
        tbody.appendChild(row);
    });
}

function updatePagination(pagination) {
    const paginationDiv = document.getElementById('pagination');
    paginationDiv.innerHTML = '';
    
    if (pagination.hasPrevPage) {
        const prevLi = document.createElement('li');
        prevLi.className = 'page-item';
        prevLi.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + (pagination.currentPage - 1) + ')">Oldingi</a>';
        paginationDiv.appendChild(prevLi);
    }
    
    for (let i = 1; i <= pagination.totalPages; i++) {
        if (i === pagination.currentPage || i === 1 || i === pagination.totalPages || 
            (i >= pagination.currentPage - 2 && i <= pagination.currentPage + 2)) {
            const li = document.createElement('li');
            li.className = 'page-item ' + (i === pagination.currentPage ? 'active' : '');
            li.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a>';
            paginationDiv.appendChild(li);
        } else if (i === pagination.currentPage - 3 || i === pagination.currentPage + 3) {
            const li = document.createElement('li');
            li.className = 'page-item disabled';
            li.innerHTML = '<span class="page-link">...</span>';
            paginationDiv.appendChild(li);
        }
    }
    
    if (pagination.hasNextPage) {
        const nextLi = document.createElement('li');
        nextLi.className = 'page-item';
        nextLi.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + (pagination.currentPage + 1) + ')">Keyingi</a>';
        paginationDiv.appendChild(nextLi);
    }
}

function changePage(page) {
    currentPage = page;
    refreshHashList();
}

async function deleteHash(hashId) {
    if (!confirm('Bu hashni o\'chirishni xohlaysizmi?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/hashes/' + hashId, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Hash muvaffaqiyatli o\'chirildi!');
            refreshStats();
            refreshHashList();
        } else {
            alert('Xatolik: ' + result.message);
        }
    } catch (error) {
        alert('O\'chirishda xatolik yuz berdi: ' + error.message);
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('uz-UZ', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

let searchTimeout;
document.getElementById('searchHash').addEventListener('input', function(e) {
    const searchTerm = e.target.value.trim();
    const clearBtn = document.getElementById('clearSearch');
    
    clearBtn.style.display = searchTerm.length > 0 ? 'block' : 'none';
    
    clearTimeout(searchTimeout);
    
    if (searchTerm.length >= 3) {
        searchTimeout = setTimeout(() => {
        searchHashes(searchTerm);
        }, 300);
    } else if (searchTerm.length === 0) {
        searchTimeout = setTimeout(() => {
            currentPage = 1; 
        refreshHashList();
        }, 100);
    }
});

function clearSearch() {
    document.getElementById('searchHash').value = '';
    document.getElementById('clearSearch').style.display = 'none';
    currentPage = 1;
    refreshHashList();
}

async function searchHashes(searchTerm) {
    try {
        const response = await fetch('/api/hashes/search?q=' + encodeURIComponent(searchTerm));
        const data = await response.json();
        
        if (data.success) {
            updateHashTable(data.data.hashes);
            document.getElementById('pagination').innerHTML = '';
            
            const tbody = document.getElementById('hashTableBody');
            if (data.data.hashes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Qidiruv natijasi topilmadi</td></tr>';
            }
        } else {
            console.error('Qidiruv xatoligi:', data.message);
        }
    } catch (error) {
        console.error('Qidiruvda xatolik:', error);
        const tbody = document.getElementById('hashTableBody');
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Qidiruvda xatolik yuz berdi</td></tr>';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    refreshHashList();
});
</script> 